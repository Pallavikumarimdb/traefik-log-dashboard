services:
  # Traefik Log Dashboard Agent - Go-based API service
  traefik-agent:
    build:
      context: ./agent
      dockerfile: Dockerfile
    container_name: traefik-log-dashboard-agent
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # Mount Traefik logs as read-only
      - /var/log/traefik:/logs:ro
      # Optional: Mount GeoIP database
      - ./data/geoip:/geoip:ro
      # Position tracking file for incremental reads
      - ./data/positions:/data
    environment:
      # Log file configuration
      - LOG_FILE=/logs/access.log
      - LOG_FORMAT=json
      
      # Server configuration
      - PORT=8080
      - HOST=0.0.0.0
      
      # Authentication
      - AUTH_TOKEN=${TRAEFIK_AUTH_TOKEN:-your-secret-token-here}
      
      # GeoIP database (optional)
      - GEOIP_DB=/geoip/GeoLite2-City.mmdb
      
      # Position file for incremental reading
      - POSITION_FILE=/data/.position
      
      # Log level
      - LOG_LEVEL=info
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/logs/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - traefik-log-dashboard

  # Traefik Log Dashboard - Next.js web UI
  traefik-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=http://traefik-agent:8080
    container_name: traefik-log-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # API configuration
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_API_TOKEN=${TRAEFIK_AUTH_TOKEN:-your-secret-token-here}
      
      # Next.js configuration
      - NODE_ENV=production
      - PORT=3000
    depends_on:
      traefik-agent:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - traefik-log-dashboard

  # Optional: Sample Traefik instance for testing
  traefik:
    image: traefik:v3
    container_name: traefik-sample
    restart: unless-stopped
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--accesslog=true"
      - "--accesslog.filepath=/logs/access.log"
      - "--accesslog.format=json"
    ports:
      - "80:80"
      - "8081:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik-logs:/logs
    networks:
      - traefik-log-dashboard
      - traefik-public
    profiles:
      - with-traefik

  # Optional: Sample backend application
  whoami:
    image: traefik/whoami
    container_name: whoami-sample
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami.rule=Host(`whoami.localhost`)"
      - "traefik.http.routers.whoami.entrypoints=web"
    networks:
      - traefik-public
    profiles:
      - with-traefik

networks:
  traefik-log-dashboard:
    driver: bridge
  traefik-public:
    driver: bridge

volumes:
  traefik-logs:
    driver: local

# Configuration notes:
# 
# 1. Basic usage (with existing Traefik logs):
#    docker-compose up -d
#
# 2. With sample Traefik instance:
#    docker-compose --profile with-traefik up -d
#
# 3. Environment variables:
#    Create a .env file in the same directory:
#    TRAEFIK_AUTH_TOKEN=your-secret-token
#
# 4. GeoIP Database:
#    Download GeoLite2-City.mmdb and place in ./data/geoip/
#    Download from: https://dev.maxmind.com/geoip/geolite2-free-geolocation-data
#
# 5. Custom log file location:
#    Modify the volume mount for traefik-agent:
#    - /your/custom/path:/logs:ro
#
# 6. Access the services:
#    - Dashboard: http://localhost:3000
#    - Agent API: http://localhost:8080
#    - Traefik UI: http://localhost:8081 (if using with-traefik profile)
#
# 7. View logs:
#    docker-compose logs -f traefik-agent
#    docker-compose logs -f traefik-dashboard
#
# 8. Stop services:
#    docker-compose down
#
# 9. Stop and remove volumes:
#    docker-compose down -v